<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Advisory: Accellion File Transfer Appliance Vulnerability — DEVCORE 戴夫寇爾</title><link href="/stylesheets/webpack_bundle.css" rel="stylesheet" /><meta content="DEVCORE 戴夫寇爾" property="og:title" />
    <meta content="DEVCORE 戴夫寇爾" property="og:site_name" />
    <meta content="http://core.dev/" property="og:url" />
    <meta content="http://core.dev/images/fb.png" property="og:image" />
    <meta content="戴夫寇爾以真實的滲透測試、顧問服務、教育訓練，保護你的商業價值。" property="og:description" />
    <meta content="website" property="og:type" />
    <meta content="612130717" property="fb:admins" />
  </head>
  <body class="blog blog_2016 blog_2016_09 blog_2016_09_22 blog_2016_09_22_advisory-accellion-file-transfer-appliance-vulnerability-eng-ver zh">
    <div class="page">
      <div class="container--wrapper">
        <div class="topbar">
          <div class="topbar__brand">
            <a href="/">
                <div class="logo">
                  DEVCORE 戴夫寇爾
                </div></a>
            <p class="slogan">
              我們提供<a href="/services/penetration-test.html" class="link">滲透測試</a>、<a href="/services/security-consulting.html" class="link">資安顧問</a>與<a href="/services/security-training.html" class="link">教育訓練</a>專業服務
            </p>
          </div>
          <div class="drawer" id="drawer">
            <div class="drawer__container">
              <nav class="main-menu">
                <div class="hidden">
                  主選單
                </div>
                <a href="/services/penetration-test.html" class="main-menu__link mobile-only">滲透測試</a>
                <a href="/services/security-consulting.html" class="main-menu__link mobile-only">資安顧問</a>
                <a href="/services/security-training.html" class="main-menu__link mobile-only">教育訓練</a>
                <a href="/services/security-seal.html" class="main-menu__link mobile-only">網站安全標章</a><a href="/about.html" class="main-menu__link">駭客思維</a><a href="/blog/" class="main-menu__link">最新訊息</a><a href="/blog/search/" class="main-menu__link main-menu__search desktop-only"><span class="hidden">搜尋</span><svg class="icon-search icon"><use xlink:href="#icon-search" /></svg></a>
              </nav>
              <a href="/contact.html" class="drawer__contact button--dense">聯絡我們</a>
              <nav class="lang-menu">
                <div class="lang-menu__label">
                  語言:
                </div>
                <a href="http://core.dev/" class="lang-menu__link">中文</a>
                <a href="http://core.dev/en/" class="lang-menu__link">English</a>
              </nav>
            </div>
          </div><span class="topbar__menu mobile-only">menu</span><button class="appearance-none topbar__hamburger mobile-only" data-toggle="#drawer" id="drawer-toggle" type="button">
            <div class="bars">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          </button>
        </div>
      </div>
      <main role="main"><div class="container--wrapper">
  <div class="container">
    <section class="blog-header">
      <small class="blog-header__category"><a href="#link">技術專欄</a></small><img src="/images/blog/20160922/Accellion-01262367.jpeg" class="blog-header__image" alt="Accellion" />
      <h1 class="blog-header__title">
        Advisory: Accellion File Transfer Appliance Vulnerability
      </h1>
      <div class="blog-header__tags">
        <a href="/blog/tag/haker.html" class="blog-header__tag">Advisory</a>
        <a href="/blog/tag/haker.html" class="blog-header__tag">Facebook</a>
        <a href="/blog/tag/haker.html" class="blog-header__tag">BugBounty</a>
        <a href="/blog/tag/haker.html" class="blog-header__tag">RCE</a>
        <a href="/blog/tag/haker.html" class="blog-header__tag">CVE</a>
      </div>
      <p class="blog-header__info">
        Written by <span class="blog-author-photo" style="background-image: url(/images/member-orange-879c85c7.jpg)"></span> <a href="/blog/author/Orange%20Tsai.html" class="author-name">Orange Tsai</a> <time class="date">on 2016-09-22 </time>
      </p>
    </section>
    <article class="article"><h3 id="about-accellion-fta">About Accellion FTA</h3>

<p>Accellion File Transfer Appliance (<code>FTA</code>) is a secure file transfer service which enables users to share and sync files online with AES 128/256 encryption. The Enterprise version further incorporates SSL VPN services with integration of Single Sign-on mechanisms like AD, LDAP and Kerberos.</p>

<p></p>

<h3 id="vulnerability-details">Vulnerability Details</h3>

<p>In this research, the following vulnerabilities were discovered on the FTA version FTA_9_12_0 (13-Oct-2015 Release)</p>

<ul>
  <li>Cross-Site Scripting x 3</li>
  <li>Pre-Auth SQL Injection leads to Remote Code Execution</li>
  <li>Known-Secret-Key leads to Remote Code Execution</li>
  <li>Local Privilege Escalation x 2</li>
</ul>

<p>The above-mentioned vulnerabilities allow unauthenticated attackers to remotely attack FTA servers and gain highest privileges successfully. After the attackers fully controlled the servers, they will be able to retrieve the encrypted files and user data, etc.</p>

<p>After reporting to CERT/CC, these vulnerabilities were assigned 4 CVEs (CVE-2016-2350, CVE-2016-2351, CVE-2016-2352, CVE-2016-2353).</p>

<h3 id="areas-affected">Areas Affected</h3>

<p>According to a public data reconnaissance, there are currently 1,217 FTA servers online around the world, most of which are located in the US, followed by Canada, Australia, UK, and Singapore.<br />
Determine from the domain name and SSL Certificate of these servers, FTA is widely used by governmental bodies, educational institutions, enterprises, including several well-known brands.</p>

<h3 id="vulnerability-analysis-and-exploitation">Vulnerability Analysis and Exploitation</h3>

<h4 id="multiple-cross-site-scripting-cve-2016-2350">Multiple Cross-Site Scripting (CVE-2016-2350)</h4>

<h5 id="xss-in-movepartitionframehtml">1. XSS in move_partition_frame.html</h5>

<blockquote>
  <p>https://&lt;fta&gt;/courier/move_partition_frame.html
?f2='-prompt(document.domain);//</p>
</blockquote>

<h5 id="xss-in-getimageajaxphp">2. XSS in getimageajax.php</h5>

<blockquote>
  <p>https://&lt;fta&gt;/courier/web/getimageajax.php
?documentname="onerror="prompt(document.domain)//</p>
</blockquote>

<h5 id="xss-in-wminfohtml">3. XSS in wmInfo.html</h5>

<blockquote>
  <p>https://&lt;fta&gt;/courier/web/wmInfo.html
?msg=ssologout
&amp;loginurl="&gt;&lt;svg/onload="prompt(document.domain)</p>
</blockquote>

<h4 id="pre-auth-sql-injection-leads-to-rce-cve-2016-2351">Pre-Auth SQL Injection leads to RCE (CVE-2016-2351)</h4>

<p>After code reviewing, a pre-authentication SQL Injection vulnerability was found in FTA. This vulnerability grants malicious users access to sensitive data and personal information on the server through SQL Injection, and launch remote code execution (RCE) by further exploiting privilege-escalating vulnerabilities.<br />
The key to this problem lies in the <code>client_properties( ... )</code> function called by security_key2.api!</p>

<div class="highlight-name">/home/seos/courier/security_key2.api</div>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1">// ...</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="nx">_decrypt</span><span class="p">(</span> <span class="nv">$password</span><span class="p">,</span> <span class="nx">_generate_key</span><span class="p">(</span> <span class="nv">$g_app_id</span><span class="p">,</span> <span class="nv">$client_id</span><span class="p">,</span> <span class="nv">$g_username</span> <span class="p">)</span> <span class="p">);</span>
<span class="nx">opendb</span><span class="p">();</span>
<span class="nv">$client_info</span> <span class="o">=</span> <span class="nx">client_properties</span><span class="p">(</span> <span class="nv">$client_id</span> <span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="c1">// ...</span></code></pre></div>

<p>Among these parameters, <code>$g_app_id</code> <code>$g_username</code> <code>$client_id</code> and <code>$password</code> are controllable by the attackers. And although the function <code>_decrypt( ... )</code> handles the passwords, it does not involve in the triggering of the vulnerability.<br />
One thing to pay special attention is that the value of <code>$g_app_id</code> will be treated as a global variable which represents the current Application ID in use, and will be applied in <code>opendb( )</code> accordingly. The code in <code>opendb( )</code> includes the following lines:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">client_properties</span><span class="p">(</span><span class="nv">$client_id</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$user</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$manager</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$client_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$client_name</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$order_by</span> <span class="o">=</span> <span class="s1">'client_id'</span><span class="p">,</span> <span class="nv">$order_type</span> <span class="o">=</span> <span class="s1">'a'</span><span class="p">,</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$offset</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$exclude_del</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$user_type</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$user_status</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$user_type</span>  <span class="o">=</span> <span class="s1">''</span> <span class="o">?</span> <span class="s1">'SELECT t_mail_server.* FROM t_mail_server '</span> <span class="o">:</span> <span class="s1">'SELECT t_mail_server.*, t_profile.c_flag as profile_flag FROM t_mail_server, t_profile '</span><span class="p">);</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$client_id</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$client_name</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'client_type'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$client_type</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mysql_escape_like</span><span class="p">(</span> <span class="nv">$user</span> <span class="p">);</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user_type'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$user_type</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'manager'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$manager</span><span class="p">;</span>
    <span class="nv">$filter</span><span class="p">[</span><span class="s1">'user_status'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$user_status</span><span class="p">;</span>
    <span class="nv">$sql</span> <span class="o">&amp;=</span> <span class="nx">construct_where_clause</span><span class="p">(</span> <span class="nv">$filter</span><span class="p">,</span> <span class="nv">$exclude_del</span> <span class="p">);</span>

    <span class="c1">// ...</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>  <span class="p">);</span>
    <span class="o">@</span><span class="nb">mysql_query</span><span class="p">(</span> <span class="nv">$sql</span> <span class="p">);</span>
    <span class="p">(</span> <span class="nv">$db_result</span> <span class="o">=</span>  <span class="o">||</span> <span class="nx">fatal_error</span><span class="p">(</span> <span class="s1">'exec:mysql_query('</span> <span class="o">.</span> <span class="nv">$sql</span> <span class="o">.</span> <span class="s1">') respond:'</span> <span class="o">.</span> <span class="nb">mysql_error</span><span class="p">(</span>  <span class="p">),</span> <span class="k">__FILE__</span><span class="p">,</span> <span class="mi">221</span> <span class="p">)</span> <span class="p">);</span></code></pre></div>

<h4 id="known-secret-key-leads-to-remote-code-execution">Known-Secret-Key leads to Remote Code Execution</h4>

<p>In the previous vulnerability, one requirement to execute code remotely is the existence of a write-enabled directory for injecting webshell. But in reality, chances are there is no write-enabled directory available, thus fail to execute code through SQL Injection. But there is another way to help us accomplish RCE.</p>

<p>The precondition of this vulnerability is <strong>Known-Secret-Key stored in the database</strong></p>

<p>This is not a problem, since the database can be accessed with the SQL Injection vulnerability mentioned earlier. Also, although there are some parameter filters in the code, they can be bypassed!</p>

<h5 id="command-injection-in-yum-clientpl">2. Command Injection in "yum-client.pl"</h5>

<p>To enable system updates through web UI, the sudoers configuration in FTA exceptionally allows the user nobody to directly execute commands with root privileges and update software with the program <code>yum-client.pl</code>.</p>

<p>will grant execution freely as root!</p>

<h3 id="backdoor">Backdoor</h3>

<p>After gaining the highest privilege and carrying out server recon, we identified that several backdoors had been already planted in FTA hosts. One of them is an IRC Botnet which had been mentioned in Niara's <a href="http://www.niara.com/docs/ta-accellion-fta-cve-2015-2857.pdf">Accellion File Transfer Appliance Vulnerability</a>.<br />
Apart from that, two additional PHP Webshells of different types which had NEVER been noted in public reports were also identified. Through reviewing Apache Log, these backdoors might be placed by exploiting the CVE-2015-2857 vulnerability discovered in mid-2015.</p>

<p>One of the backdoors is PHPSPY, it is found on 62 of the online hosts globally. It was placed in</p>

<blockquote>
  <p>https://&lt;fta&gt;/courier/themes/templates/Redirector_Cache.php</p>
</blockquote>

<p>The other is WSO, found on 9 of the online hosts globally, placed in</p>

<blockquote>
  <p>https://&lt;fta&gt;/courier/themes/templates/imag.php</p>
</blockquote>

<h3 id="acknowledgement">Acknowledgement</h3>

<p>The vulnerability mentioned in this Advisory was identified in early 2016 while looking for vulnerabilities in Facebook, you can refer to the article "<a href="http://devco.re/blog/2016/04/21/how-I-hacked-facebook-and-found-someones-backdoor-script-eng-ver/">How I Hacked Facebook, and Found Someone's Backdoor Script</a>".<br />
Upon discovering the FTA vulnerability in early February, I notified Facebook and Accellion and both were very responsive. Accellion responded immediately, issuing patch FTA_9_12_40 on February 12th and notifying all affected customers about the vulnerability and instructions to install the patch. Accellion has been very communicative and cooperative throughout this process.</p>

<h3 id="timeline">Timeline</h3>

<ul>
  <li>Feb  6, 2016 05:21 Contact Accellion for vulnerability report</li>
  <li>Feb  7, 2016 12:35 Send the report to Accellion Support Team</li>
  <li>Mar  3, 2016 03:03 Accellion Support Team notifies patch will be made in FTA_9_12_40</li>
  <li>May 10, 2016 15:18 Request Advisory submission approval and report the new discovery of two backdoors to Accellion</li>
  <li>Jun  6, 2016 10:20 Advisory finalized by mutual consent</li>
</ul>

<h3 id="references">References</h3>

<ul>
  <li><a href="https://community.rapid7.com/community/metasploit/blog/2015/07/10/r7-2015-08-accellion-file-transfer-appliance-vulnerabilities-cve-2015-2856-cve-2015-2857">R7-2015-08: Accellion File Transfer Appliance Vulnerabilities (CVE-2015-2856, CVE-2015-2857)</a> <a name="ref1"></a></li>
  <li><a href="https://www.rapid7.com/resources/advisories/R7-0039.jsp">Rapid7 Advisory R7-0039: Accellion File Transfer Appliance Multiple Vulnerabilities</a> <a name="ref2"></a></li>
  <li><a href="http://www.niara.com/docs/ta-accellion-fta-cve-2015-2857.pdf">Threat Advisory: Accellion File Transfer Appliance Vulnerability</a> <a name="ref3"></a></li>
</ul>

    </article>
    <p class="sns-widgets">
      Share this on <button class="appearance-none sns-widgets__button" id="sns-facebook" type="button">Facebook</button> or <button class="appearance-none sns-widgets__button" id="sns-twitter" type="button">Twitter</button>
    </p><div class="heading--side-lined">
      About <span class="blog-author-photo" style="background-image: url(/images/member-orange-879c85c7.jpg)"></span> <span class="blog-author-name">Orange Tsai</span> 
    </div>
    <p class="blog-author-info">
      具備多年駭客技術研究以及網路管理經驗，擔任學術及政府單位專任講師及顧問。專長於網站應用程式安全、滲透測試、伺服器建置及開發、專業教育訓練。
    </p><div class="heading--side-lined">
      讀者留言
    </div>
    <div class="blog-comments">
      DISQUS 塞這裡
    </div>
  </div>
</div></main>
      <div class="container--wrapper">
        <div class="relative-posts">
          <div class="heading--side-lined container">
            相關文章
          </div>
          <div class="relative-posts__cells">
            <section class="card">
              <a href="/blog/2016/04/21/how-I-hacked-facebook-and-found-someones-backdoor-script.html">
                <div class="card__thumbnail" style="background-image: url(/images/blog-thumbnail-0-98e2cb44.jpg)"></div>
                <h3 class="card__title">
                  WEB2PY 反序列化的安全問題－CVE-2016-3957
                </h3></a>
              <div class="card__tags">
                <a href="#link" class="card__tag">Advisory</a>
                <a href="#link" class="card__tag">Facebook</a>
                <a href="#link" class="card__tag">BugBounty</a>
                <a href="#link" class="card__tag">RCE</a>
                <a href="#link" class="card__tag">CVE</a>
              </div>
              <small class="card__category"><a href="#link">技術專欄</a></small>
            </section>
            <section class="card">
              <a href="/blog/2014/10/13/android-webview-left-shortcuts-for-hacker.html">
                <div class="card__thumbnail" style="background-image: url(/images/blog-thumbnail-1-95c2e1f4.jpg)"></div>
                <h3 class="card__title">
                  IoT設備商別成為幫兇 從Dyn DDoS攻擊事件看IoT安全
                </h3></a>
              <div class="card__tags">
                <a href="#link" class="card__tag">Mobile</a>
                <a href="#link" class="card__tag">Android</a>
                <a href="#link" class="card__tag">WebView</a>
                <a href="#link" class="card__tag">UXSS</a>
              </div>
              <small class="card__category"><a href="#link">技術專欄</a></small>
            </section>
            <section class="card">
              <a href="/blog/2016/09/22/advisory-accellion-file-transfer-appliance-vulnerability-eng-ver.html">
                <div class="card__thumbnail" style="background-image: url(/images/blog-thumbnail-2-a989726c.jpg)"></div>
                <h3 class="card__title">
                  Accellion File Transfer Appliance 弱點報告
                </h3></a>
              <div class="card__tags">
                <a href="#link" class="card__tag">Facebook</a>
                <a href="#link" class="card__tag">BugBounty</a>
                <a href="#link" class="card__tag">RCE</a>
                <a href="#link" class="card__tag">Backdoor</a>
                <a href="#link" class="card__tag">Reconnaissance</a>
                <a href="#link" class="card__tag">Pentest</a>
              </div>
              <small class="card__category"><a href="#link">技術專欄</a></small>
            </section>
          </div>
        </div><div class="contact-section container">
          <h2 class="contact-section__title">
            用最真實的攻擊，驗證企業的防禦
          </h2>
          <a href="/contact.html" class="home-contact__button button--dense">聯絡我們</a>
        </div><footer class="main-footer">
          <div class="main-footer__about">
            戴夫寇爾提供<br class="mobile-only" /><a href="/services/penetration-test.html" class="link">滲透測試</a>、<a href="/services/security-consulting.html" class="link">資安顧問</a>與<a href="/services/security-training.html" class="link">教育訓練</a>專業服務<br />在<a href="https://www.facebook.com/D3VC0RE" class="link">Facebook</a>或<a href="https://twitter.com/d3vc0r3" class="link">Twitter</a>上追蹤我們的<a href="/blog/" class="link">最新訊息</a><br />瞭解更多戴夫寇爾的<a href="/about.html" class="link">駭客思維</a>
          </div>
          <div class="main-footer__snses"><a href="https://www.facebook.com/D3VC0RE" class="main-footer__sns">
                <svg class="icon-fb icon"><use xlink:href="#icon-fb" /></svg></a><a href="https://plus.google.com/118439315679478709768/posts" class="main-footer__sns">
                <svg class="icon-googleplus icon"><use xlink:href="#icon-googleplus" /></svg></a><a href="https://twitter.com/d3vc0r3" class="main-footer__sns">
                <svg class="icon-twitter icon"><use xlink:href="#icon-twitter" /></svg></a>
          </div>
          <address class="main-footer__address">
            <ul class="list--unstyled">
              <li>
                地址 10487 台北市中山區復興北路168號10樓
              </li>
              <li>
                Email contact@devco.re
              </li>
              <li>
                電話 02-2718-0156
              </li>
              <li>
                統編 53955237
              </li>
            </ul>
          </address><small class="main-footer__copyright"><a href="/" class="logo">DEVCORE</a>©2016 DEVCORE 戴夫寇爾</small>
        </footer>
      </div>
    </div>
    <script src="/javascripts/webpack_bundle.js"></script>
  </body>
</html>